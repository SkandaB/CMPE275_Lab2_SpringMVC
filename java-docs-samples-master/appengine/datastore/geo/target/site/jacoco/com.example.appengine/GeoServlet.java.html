<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GeoServlet.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">appengine-datastore-geo</a> &gt; <a href="index.source.html" class="el_package">com.example.appengine</a> &gt; <span class="el_source">GeoServlet.java</span></div><h1>GeoServlet.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2016 Google Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.example.appengine;

import com.google.appengine.api.datastore.DatastoreService;
import com.google.appengine.api.datastore.DatastoreServiceFactory;
import com.google.appengine.api.datastore.Entity;
import com.google.appengine.api.datastore.FetchOptions;
import com.google.appengine.api.datastore.GeoPt;
import com.google.appengine.api.datastore.Query;
import com.google.appengine.api.datastore.Query.CompositeFilterOperator;
import com.google.appengine.api.datastore.Query.Filter;
import com.google.appengine.api.datastore.Query.FilterOperator;
import com.google.appengine.api.datastore.Query.FilterPredicate;
import com.google.appengine.api.datastore.Query.GeoRegion.Circle;
import com.google.appengine.api.datastore.Query.GeoRegion.Rectangle;
import com.google.appengine.api.datastore.Query.StContainsFilter;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.List;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * A servlet to demonstrate the use of Cloud Datastore geospatial queries.
 */
public class GeoServlet extends HttpServlet {
  static final String BRAND_PROPERTY = &quot;brand&quot;;
  static final String LOCATION_PROPERTY = &quot;location&quot;;

  static final String BRAND_PARAMETER = &quot;brand&quot;;
  static final String LATITUDE_PARAMETER = &quot;lat&quot;;
  static final String LONGITUDE_PARAMETER = &quot;lon&quot;;
  static final String RADIUS_PARAMETER = &quot;r&quot;;

  static final String BRAND_DEFAULT = &quot;Ocean Ave Shell&quot;;
  static final String LATITUDE_DEFAULT = &quot;37.7895873&quot;;
  static final String LONGITUDE_DEFAULT = &quot;-122.3917317&quot;;
  static final String RADIUS_DEFAULT = &quot;1000.0&quot;;

  // Number of meters (approximately) in 1 degree of latitude.
  // http://gis.stackexchange.com/a/2964
  private static final double DEGREE_METERS = 111111.0;

  private final DatastoreService datastore;

<span class="fc" id="L65">  public GeoServlet() {</span>
<span class="fc" id="L66">    datastore = DatastoreServiceFactory.getDatastoreService();</span>
<span class="fc" id="L67">  }</span>

  private static String getParameterOrDefault(
      HttpServletRequest req, String parameter, String defaultValue) {
<span class="fc" id="L71">    String value = req.getParameter(parameter);</span>
<span class="pc bpc" id="L72" title="1 of 4 branches missed.">    if (value == null || value.isEmpty()) {</span>
<span class="fc" id="L73">      value = defaultValue;</span>
    }
<span class="fc" id="L75">    return value;</span>
  }

  private static GeoPt getOffsetPoint(
      GeoPt original, double latOffsetMeters, double lonOffsetMeters) {
    // Approximate the number of degrees to offset by meters.
    // http://gis.stackexchange.com/a/2964
    // How long (approximately) is one degree of longitude?
<span class="fc" id="L83">    double lonDegreeMeters = DEGREE_METERS * Math.cos(original.getLatitude());</span>
<span class="fc" id="L84">    return new GeoPt(</span>
<span class="fc" id="L85">        (float) (original.getLatitude() + latOffsetMeters / DEGREE_METERS),</span>
        // This may cause errors if given points near the north or south pole.
<span class="fc" id="L87">        (float) (original.getLongitude() + lonOffsetMeters / lonDegreeMeters));</span>
  }

  @Override
  public void doGet(HttpServletRequest req, HttpServletResponse resp)
      throws IOException, ServletException {
<span class="fc" id="L93">    resp.setContentType(&quot;text/plain&quot;);</span>
<span class="fc" id="L94">    resp.setCharacterEncoding(&quot;UTF-8&quot;);</span>
<span class="fc" id="L95">    PrintWriter out = resp.getWriter();</span>

<span class="fc" id="L97">    String brand = getParameterOrDefault(req, BRAND_PARAMETER, BRAND_DEFAULT);</span>
<span class="fc" id="L98">    String latStr = getParameterOrDefault(req, LATITUDE_PARAMETER, LATITUDE_DEFAULT);</span>
<span class="fc" id="L99">    String lonStr = getParameterOrDefault(req, LONGITUDE_PARAMETER, LONGITUDE_DEFAULT);</span>
<span class="fc" id="L100">    String radiusStr = getParameterOrDefault(req, RADIUS_PARAMETER, RADIUS_DEFAULT);</span>

    float latitude;
    float longitude;
    double r;
    try {
<span class="fc" id="L106">      latitude = Float.parseFloat(latStr);</span>
<span class="fc" id="L107">      longitude = Float.parseFloat(lonStr);</span>
<span class="fc" id="L108">      r = Double.parseDouble(radiusStr);</span>
<span class="fc" id="L109">    } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L110">      resp.sendError(</span>
<span class="fc" id="L111">          HttpServletResponse.SC_BAD_REQUEST, String.format(&quot;Got bad value: %s&quot;, e.getMessage()));</span>
<span class="fc" id="L112">      return;</span>
<span class="fc" id="L113">    }</span>

    // Get lat/lon for rectangle.
<span class="fc" id="L116">    GeoPt c = new GeoPt(latitude, longitude);</span>
<span class="fc" id="L117">    GeoPt ne = getOffsetPoint(c, r, r);</span>
<span class="fc" id="L118">    float neLat = ne.getLatitude();</span>
<span class="fc" id="L119">    float neLon = ne.getLongitude();</span>
<span class="fc" id="L120">    GeoPt sw = getOffsetPoint(c, -1 * r, -1 * r);</span>
<span class="fc" id="L121">    float swLat = sw.getLatitude();</span>
<span class="fc" id="L122">    float swLon = sw.getLongitude();</span>

    // [START geospatial_stcontainsfilter_examples]
    // Testing for containment within a circle
<span class="fc" id="L126">    GeoPt center = new GeoPt(latitude, longitude);</span>
<span class="fc" id="L127">    double radius = r; // Value is in meters.</span>
<span class="fc" id="L128">    Filter f1 = new StContainsFilter(&quot;location&quot;, new Circle(center, radius));</span>
<span class="fc" id="L129">    Query q1 = new Query(&quot;GasStation&quot;).setFilter(f1);</span>

    // Testing for containment within a rectangle
<span class="fc" id="L132">    GeoPt southwest = new GeoPt(swLat, swLon);</span>
<span class="fc" id="L133">    GeoPt northeast = new GeoPt(neLat, neLon);</span>
<span class="fc" id="L134">    Filter f2 = new StContainsFilter(&quot;location&quot;, new Rectangle(southwest, northeast));</span>
<span class="fc" id="L135">    Query q2 = new Query(&quot;GasStation&quot;).setFilter(f2);</span>
    // [END geospatial_stcontainsfilter_examples]

<span class="fc" id="L138">    List&lt;Entity&gt; circleResults = datastore.prepare(q1).asList(FetchOptions.Builder.withDefaults());</span>
<span class="fc" id="L139">    out.printf(&quot;Got %d stations in %f meter radius circle.\n&quot;, circleResults.size(), radius);</span>
<span class="fc" id="L140">    printStations(out, circleResults);</span>
<span class="fc" id="L141">    out.println();</span>

<span class="fc" id="L143">    List&lt;Entity&gt; rectResults = datastore.prepare(q2).asList(FetchOptions.Builder.withDefaults());</span>
<span class="fc" id="L144">    out.printf(&quot;Got %d stations in rectangle.\n&quot;, rectResults.size());</span>
<span class="fc" id="L145">    printStations(out, rectResults);</span>
<span class="fc" id="L146">    out.println();</span>

<span class="fc" id="L148">    List&lt;Entity&gt; brandResults = getStationsWithBrand(center, radius, brand);</span>
<span class="fc" id="L149">    out.printf(&quot;Got %d stations in circle with brand %s.\n&quot;, brandResults.size(), brand);</span>
<span class="fc" id="L150">    printStations(out, brandResults);</span>
<span class="fc" id="L151">    out.println();</span>
<span class="fc" id="L152">  }</span>

  private void printStations(PrintWriter out, List&lt;Entity&gt; stations) {
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">    for (Entity station : stations) {</span>
<span class="nc" id="L156">      GeoPt location = (GeoPt) station.getProperty(LOCATION_PROPERTY);</span>
<span class="nc" id="L157">      out.printf(</span>
          &quot;%s: @%f, %f\n&quot;,
<span class="nc" id="L159">          (String) station.getProperty(BRAND_PROPERTY),</span>
<span class="nc" id="L160">          location.getLatitude(),</span>
<span class="nc" id="L161">          location.getLongitude());</span>
<span class="nc" id="L162">    }</span>
<span class="fc" id="L163">  }</span>

  private List&lt;Entity&gt; getStationsWithBrand(GeoPt center, double radius, String value) {
    // [START geospatial_containment_and_equality_combination]
<span class="fc" id="L167">    Filter f =</span>
<span class="fc" id="L168">        CompositeFilterOperator.and(</span>
            new StContainsFilter(&quot;location&quot;, new Circle(center, radius)),
            new FilterPredicate(&quot;brand&quot;, FilterOperator.EQUAL, value));
    // [END geospatial_containment_and_equality_combination]
<span class="fc" id="L172">    Query q = new Query(&quot;GasStation&quot;).setFilter(f);</span>
<span class="fc" id="L173">    return datastore.prepare(q).asList(FetchOptions.Builder.withDefaults());</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>